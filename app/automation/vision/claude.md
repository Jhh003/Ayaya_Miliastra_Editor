## 目录用途
- 统一封装自动化层使用的视觉识别能力（节点/端口检测、OCR 标题抽取与映射、一步式整屏识别缓存等）。
- 对上层（执行器、工具脚本、UI 调试入口）暴露稳定的 `app.automation.vision` 门面 API，内部委托给 `vision_backend` 与 `node_detection` 等具体实现。

## 当前状态
- `__init__.py`：视觉门面（Facade），提供节点列表、端口列表、缓存失效、标题映射日志、相位相关位移估计等高层 API，并对外隐藏底层实现细节。
- `vision_backend.py`：核心视觉识别后端，实现截图区域裁剪、OCR 标题提取与近似映射、节点/端口坐标转换与缓存管理等逻辑；模板目录通过 profile 解析器自动选择（避免硬编码 `4K-CN`）。调用一步式识别时对端口模板使用约 0.8 的基础置信度阈值，并在底层识别器中对部分流程端口模板（如 Process 系列）使用不高于 70% 的匹配阈值、对部分泛型数据端口模板（如 Generic 系列）使用不高于 75% 的匹配阈值，以在保持整体精度的前提下提高关键端口的识别召回率。相位相关位移估计会基于 OpenCV `response` 做可信度过滤，低响应时返回 (0,0) 交由上层回退逻辑处理，避免坐标映射漂移。标题近似映射在判定“是否唯一可回退”时会对候选完整名做去重，避免 client/server 同名重复注册导致误判为多解而放弃纠错。
- `ui_profile_params.py`：基于"实际显示设置（分辨率宽度档位 + Windows 缩放）"推导"分辨率/缩放敏感的像素参数"（端口标题栏排除高度、候选列表裁剪参数、缩放 ROI 尺寸等），并保留当前选择的 OCR 模板 profile 名用于调试；避免各处散落硬编码。端口标题栏排除高度会根据分辨率档位和缩放比例计算，端口识别使用的最终值会夹取到 **[20px, 26px]**（4K125 实测 26px；所有分辨率都不应超过此上限，且不应低于 20px 以避免排除区域过小）。
- `ui_profile_params.py` 在未注册默认 workspace 时会按目录结构回退到仓库根目录（`assets/` + `tools/` 同级）解析 profile，保证 UI 调试入口与识别后端对同一台机器的显示设置使用一致参数。
- 端口模板匹配会跳过节点顶部标题栏区域（高度由 `ui_profile_params` 解析，门面通过 `get_port_recognition_header_height_px()` 提供）；执行监控叠加层与调试工具复用同一入口，避免多处重复硬编码导致显示/识别不一致。
- `ocr_utils.py`：OCR 引擎获取与中文文本抽取工具函数，统一封装 RapidOCR 使用方式。
- `node_detection.py`：基于模板匹配/色块检测等能力的节点与端口检测辅助逻辑。
- `ocr_template_profile.py`：OCR 模板 profile 扫描与自动选择（按屏幕宽度档位 + Windows 缩放 + 语言），并提供“profile 不匹配时”的提示文案；支持通过环境变量 `GRAPH_GENERATER_OCR_TEMPLATE_PROFILE` 强制指定 profile。

## 注意事项
- 所有运行时代码与 CLI 工具如需调用视觉识别能力，应通过 `app.automation.vision` 入口导入，不直接依赖 `tools/*` 中的实现脚本。
- 窗口客户区截图等能力位于 `app.automation.capture`；`app.automation.vision` 仅在需要时做薄转发，避免在视觉门面中引入额外耦合。
- 模块内不做异常吞没，错误应直接抛出交由调用方或全局异常钩子处理。
- 避免在此处硬编码具体工作区路径或外部资源位置；OCR 模板路径统一通过 profile 解析与工作区解析得到。
- 与分辨率/缩放强相关的像素常量（含端口标题栏高度、候选列表裁剪等）应优先向“profile/配置驱动”演进；当前风险点清单见 `docs/diagnostics/自动化识别_写死像素区域清单.md`。


