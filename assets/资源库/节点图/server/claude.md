# 节点图（Server）目录说明

## 目录用途
存放服务器侧节点图脚本文件。每个脚本内定义一个可挂载到运行时实体的节点图类，包含事件注册与事件处理函数，用于在服务器侧表达事件驱动的节点图逻辑。

## 文档约定（重要）
- 这里只描述目录用途与规范，不记录具体资源清单/不解释单个资源是做什么的
- 本 `claude.md` **只描述目录用途、编写规范与边界条件**。
- **不在此列举本目录下具体有哪些节点图文件**，也不解释单个节点图“是干什么的”。

## 当前状态
稳定可用。本目录包含若干用于教学/测试/回归的服务端节点图脚本，覆盖常见事件入口、控制流与运行期 API 使用方式（不在本文档维护清单）。

## 注意事项
### 运行时与导入约定
- 节点图事件通过 `GameRuntime.register_event_handler(event_name, handler, owner)` 注册；事件触发由 `GameRuntime.trigger_event(event_name, **kwargs)` 驱动。
- 建议使用统一的“服务端预设导入头”，以便直接使用节点函数与类型注解（不在本文档写死具体文件名，避免文档与实现耦合）。

### 事件入口命名约束（类结构节点图）
- 事件处理函数命名建议以 `on_事件名` 形式，并在 `register_handlers` 中完成注册。
- 只要方法名以 `on_` 开头，其后缀必须是“内置事件名”或“已定义信号名/信号ID”；禁止写 `on_随便起名` 作为占位。
- 内置事件（如 `定时器触发时`）的回调必须严格命名为 `on_定时器触发时`，禁止追加后缀（如 `on_定时器触发时_倒计时`）。

### 控制流与条件表达
- 支持“选择性汇合”：在分支体内使用 `return` 可表示该分支终止当前事件流、且不与后续公共逻辑汇合（其他未 `return` 的分支仍会自动汇合）。
- if 条件只能接收单一布尔输入，禁止直接书写 Python 比较表达式（如 `A == B`、`X is None`）；请使用布尔节点输出的变量作为条件。
- 代码规范校验禁止在 if 条件中直接调用【逻辑非运算】；需要取反时推荐写成 `if 条件: pass else: return/continue`，或先将取反结果赋给布尔变量再用于分支。
- 代码规范校验会对“布尔变量与 True/False 的冗余比较”给出告警；推荐直接使用布尔变量本身作为条件：`if 布尔变量:`

### 节点调用与静态解析约束
- 节点函数名必须来自节点库；若出现未知函数调用，将在校验阶段报错，用于提前发现拼写错误或引用了不存在的节点。
- 禁止在类中编写承载业务逻辑的自定义/私有方法；节点图逻辑应全部写在 `on_` 开头的事件方法中。
- 校验会检查类中所有方法（跳过 `__init__` 与 `register_handlers`）；任何 Python 方法/函数调用（如 `.items()` / `.get()` / `sorted(...)` / `lambda`）都会被报错。
- for 循环仅允许 `range(...)` 用于迭代次数，且仅作为 `for` 的迭代器位置出现；其余位置调用 `range(...)` 同样会被报错。
- 禁止在 `range()` 参数中使用内联算术运算；必须先用节点计算结果并存入变量，再将该变量传递给 `range()`。
- 字典/列表下标赋值（如 `a[b] = v`）不允许；请使用列表/字典相关节点完成修改。
- 【获取局部变量】为二元输出（`局部变量句柄`、`值`）：必须二元解包（`句柄, 当前值 = 获取局部变量(self.game, 初始值=...)`）或显式下标取值（`获取局部变量(...)[0/1]`）；禁止把返回结果当作单值直接使用。

### 复用与中继规范
- `获取自身实体` 在 ≤5 个流程节点范围内若出现重复调用，必须复用同一结果；或在使用点前添加【获取局部变量(初始值=获取自身实体)】作为中继并复用其输出。
- 一般数据跨越 ≥5 个流程节点的“长连线”在多处复用时会报错；若仅出现一次或经由【获取局部变量】在使用点前中继则豁免。

### 拉取式执行器的“重复求值风险”提示（warning）
- 当出现“读-改-写同一自定义变量”（【获取自定义变量】→ 计算 →【设置自定义变量】）且写入后仍继续依赖同一个读取节点实例时，校验会给出 warning。
- 规避方式：将后续依赖移动到写入前；或在写入后重新用新的【获取自定义变量】读取；或用【获取局部变量】在使用点中继/拆分读取链路，避免复用同一读取节点实例。

### 变量与空值约束
- 禁止在节点图中使用 `None` 作为占位或比较值。
- 所有变量在首次读取前必须显式初始化为合法默认值（如 `0`、`""`、以及通过【拼装列表】/【建立字典】构造的空容器），不得以 `None` 代表“未初始化”。
- 运行期 API 若返回 `None`，应在逻辑上立即抛出错误，避免继续分支容忍或隐式转换。

### 类型一致性提示
- GUID 与字符串必须严格区分：凡标注为 `GUID` 的变量、端口与自定义变量，传参与注解均应为 `"GUID"`，不可用 `"字符串"` 代替。
- 复合类型入参（如“三维向量”）：允许直接使用 Python 元组字面量作为常量输入（如 `(0.0, 0.0, 0.0)`），也可使用已登记的节点构造。

### 分支节点的正确使用方式
- **双分支节点**：使用 `if-else` 语句，基于布尔条件（真/假）进行分支。
- **多分支节点**：使用 `match-case` 语句，基于整数/字符串值进行多路分支。
- **不要使用 `if-elif-else`**：它会被解析为嵌套的双分支节点，而不是单个多分支节点。

## 校验与自检
- 每个服务端节点图脚本建议提供可直接运行的自检入口（通常通过统一的节点图校验器对当前脚本做规范校验）。
- 项目提供统一的节点图/复合节点校验入口，可在项目根目录执行一次性全量校验。

---
注意：本文件不记录任何修改历史。请始终保持对"目录用途、当前状态、注意事项"的实时描述。


